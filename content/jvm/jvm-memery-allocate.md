+++

date = "2020-12-21"

title = "《深入理解JVM》——05.JVM内存分配"

description = "深入理解Java虚拟机第三版"

series = ["book", "jvm"]

+++

## Java虚拟机内存分配与回收策略

java体系的自动内存管理，最根本的目的是自动化地解决两个问题：
1. 自动给对象分配内存
2. 自动回收分配给对象的内存

在经典分代的设计下，新生对象通常会分配在新生代中，少数情况下也**可能**分配在老年代。

对象优先在Eden分配
-

大多数情况下 ，对象在新生代Eden区中分配。当Eden中没有足够空间进行分配时，虚拟机将发起一次Minor GC。HotSpot虚拟机提供了`-XX:+PrintGCDetails`这个收集器日志参数，告诉虚拟机在发生垃圾收集行为时打印内存回收日志，并且在进程退出时输出当前内存各个区域分配情况。

大对象直接进入老年代
-

HotSpot虚拟机提供了`-XX:PretenureSizeThreshold`参数（只对Serial和ParNew两款新生代收集器有效），指定大于该设置值的对象直接在老年代分配，这样做的目的就是**避免在Eden区及两个Survivor区之间来回复制，产生大量的内存复制操作**

长期存活的对象将进入老年代
-

虚拟机给每个对象定义了一个对象年龄（Age）计数器，存储在对象头中。对象通常在Eden区里诞生，如果经过第一次Minor GC后仍然存活，并且能被Survivor容纳的话，该对象会被移动到Survivor空间中，并且将其的年龄设置成1岁。对象在Survivor区中每熬过；一次Minor GC，年龄增加1岁，当它的年龄增加到一定程度（默认15岁），就会被晋升到老年代中。**对对象的晋升老年代的年龄阈值，可以通过参数`-XX:MaxTenuringThreshold`设置**

动态对象的判定
-
如果在Survivor空间中相同年龄所有对象大小的总和大于Survivor空间的一半，年龄大于或等于该年龄的对象就可以直接进入老年代，无须等到`-XX:MaxTenuringThreshold`要求的年龄。

空间分配担保
-
在发生Minor GC之前，虚拟机必须先检查老年代最大可用的连续空间是否大于新生代所有对象总空间，如果这个成立，则虚拟机会先查看`-XX:HandkePromotionFailure`参数的设置值是否允许担保失败；如果允许，那会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试进行一次Minor GC，尽管这次Minor GC是有风险的；如果小于，或者`-XX:HandlePromotionFailure`设置不允许冒险，那这时就要改为进行一次Full GC。
                                                                                                                                                                                                                                                                                                                                                                                                                                                



















































