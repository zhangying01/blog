+++

date = "2020-12-28"

title = "《深入理解JVM》——07.类文件结构"

description = "深入理解Java虚拟机第三版"

series = ["book", "jvm"]

+++

## 类文件结构

概述
-

不仅仅是Java。任何一种语言，只要将其编译成class文件，即可在jvm中运行。

Class类文件的结构
-
``` java
ClassFile {
    u4             magic;
    u2             minor_version;
    u2             major_version;
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    u2             methods_count;
    method_info    methods[methods_count];
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```
Class文件是一组以8个字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在文件之中，中间没有任何分隔符。当需要需要占用8个字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8个字节进行存储。

Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种结构只有两种数据类型：“无符号数”和“表”。
1. 无符号数属于基本的数据类型，u1,u2,u4,u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，无符号数可以用来描述数字、索引引用、数量值或者按照UFT-8编码构成字符串值。
2. 表是由多个无符号数或者其他表作为数据项构成的符合数据类型，所有的表的命名都习惯地以“_info”结尾。表是用于描述有层次关系的复合结构的数据，整个Class文件本质上也可以视作是一张表，

魔数，有趣的东西，用来识别文件是不是java的class文件，因为后缀可以变动，而编译后文件的内容不会变，class文件前4个字节的魔数为COFEBABE，咖啡宝贝。在gif和jpeg文件头中都存在魔数这个东西。后4个字节 存储的是Class文件的版本号。5，6个字节存储的次版本号。


常量池
-
Class文件主次版本号后面紧接着就是常量池入口，常量池可以比喻为Class文件里的资源仓库，**它是Class文件结构中与其他项目关联最多的数据，通常也是占用Class文件空间最大的数据项目之一，另外它还是Class文件中第一个出现的表类型数据项目**，

由于常量池中常量的数量不是固定的，所以在常量池的入口放置了一项u2类型的数据，代表常量池容量计数值(constant_pool_count)。此容量是从1开始的而不是从0，为的是，在特定情况下表达“不引用任何一个的常量池项目”。把索引设置为0来表示。除了此常量池计数器，其他的类型都是从0开始的。

常量池中主要存放2大类常量：字面量和符号引用
1. 字面量。如文本字符、被声明的final的常量值。
2. 符号引用。编译原理方面的概念。
    1. 被模块导出或者开放的包
    2. 类和接口的全限定名
    3. 字段的名称和描述符
    4. 方法的名称和描述符
    5. 方法句柄和方法类型
    6. 动态调用点和动态常量

**在Class文件中不会保存各个方法、字段最终在内存中的布局信息，这些字段、方法的符号引用不仅过java虚拟机在运行期转换的话是无法得到真正的内存入口地址，也就无法直接被虚拟机使用。当虚拟机做类加载时，将会从常量池获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址之中。**

常量池中每一项常量都是一个表，这类表都有一个共同的特点，表结构起始的第一个u1类型的标志位tag，代表着当前常量属于哪种常量类型。

下面此说明十分重要，这就完全说明java可以在运行中改变一些类的行为，实现语言使用者的定制化服务。

>任何一个Class文件都对应着唯一的一个类或者接口的定义信息，但是反过来说，类或者接口并不一定都得定义在文件里（譬如类或者接口也可以动态生成，直接送入类加载器中）。


                                                                                    

- [目录](../)
- 上一章：[JVM性能监控及故障处理命令](../jvm-6-tool)
- 下一节：[JVM性能监控及故障处理命令](../jvm-6-tool)


















































